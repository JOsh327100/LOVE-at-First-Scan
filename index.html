<script>
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const statusText = document.getElementById("status");
const resultText = document.getElementById("result");
const quoteText = document.getElementById("quote");
const music = document.getElementById("bgMusic");

let userCaptured = false;
let resultShown = false;
let scanInterval = null;

const quotes = [
  "Love begins with a smile ðŸ’–",
  "Two hearts, one connection ðŸ’•",
  "Destiny just scanned you âœ¨",
  "Love found its way ðŸ’˜",
  "A perfect match in the moment ðŸ’ž"
];

function isPhone() {
  return /Android|iPhone|iPod|Opera Mini|IEMobile/i.test(navigator.userAgent);
}

window.addEventListener("load", () => {
  if (isPhone()) {
    instructionModal.classList.add("hidden");
    blockedModal.classList.remove("hidden");
  }
});

function openGuide() {
  instructionModal.classList.add("hidden");
  guideModal.classList.remove("hidden");
  music.play().catch(()=>{});
}

function startApp() {
  guideModal.classList.add("hidden");
  scanArea.classList.remove("hidden");
  music.play().catch(()=>{});
  loadModels();
}

function loadModels() {
  faceapi.nets.tinyFaceDetector
    .loadFromUri("https://unpkg.com/face-api.js/models")
    .then(startCamera);
}

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(() => {
      statusText.textContent = "Camera access denied.";
    });
}

video.addEventListener("loadedmetadata", () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
});

video.addEventListener("play", () => {
  if (scanInterval) clearInterval(scanInterval);

  scanInterval = setInterval(async () => {
    const detections = await faceapi.detectAllFaces(
      video,
      new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.5 })
    );

    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (detections.length === 0) {
      statusText.textContent = "Scanning your face...";
      return;
    }

    // FIRST FACE = USER
    if (detections.length >= 1) {
      const box = detections[0].box;
      ctx.strokeStyle = "#00ffcc";
      ctx.lineWidth = 3;
      ctx.strokeRect(box.x, box.y, box.width, box.height);

      if (!userCaptured) {
        userCaptured = true;
        statusText.textContent = "Face captured. Scanning surroundings...";
      }
    }

    // SECOND FACE = PARTNER
    if (detections.length >= 2 && userCaptured && !resultShown) {
      const box = detections[1].box;
      ctx.strokeStyle = "#ffcc00";
      ctx.lineWidth = 3;
      ctx.strokeRect(box.x, box.y, box.width, box.height);

      resultShown = true;
      statusText.textContent = "Match found!";
      animateResult();
    }
  }, 400);
});

function animateResult() {
  let target = Math.floor(Math.random() * 41) + 60;
  let count = 0;
  quoteText.textContent = quotes[Math.floor(Math.random() * quotes.length)];

  const timer = setInterval(() => {
    resultText.textContent = `ðŸ’– ${count}% Connected`;
    if (count >= target) clearInterval(timer);
    count++;
  }, 30);
}

function resetScan() {
  userCaptured = false;
  resultShown = false;
  resultText.textContent = "";
  quoteText.textContent = "";
  statusText.textContent = "Scanning your face...";
}
</script>
